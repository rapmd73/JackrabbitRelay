#!/bin/bash
pip3=`which pip3`
OFS=`stat --printf="%s" update`

BaseDir="/home/JackrabbitRelay2"

cd /home/GitHub/JackrabbitRelay

for i in `cat requirements.txt` ; do
    $pip3 install -U $i
done
mkdir -p $BaseDir > /dev/null 2>&1
for d in Base Config Data Logs Ledger Statistics/Balances Statistics/Charts ; do
    mkdir -p $BaseDir/$d > /dev/null 2>&1
done

cp -r * $BaseDir

if [ x$1 != 'xnopull' ] ; then
    for i in `cat requirements.txt` ; do
        $pip3 install -U $i
    done

    for i in $BaseDir/Data/*.symbolmap ; do 
        N=`echo $i | cut -d/ -f5 | cut -d. -f1`
        $BaseDir/Extras/TV2Exchange $N
    done

fi

git pull https://github.com/rapmd73/JackrabbitRelay

#if test -f /home/Equilibrium/install ; then
#    /home/GitHub/JackrabbitRelay/Extras/Equilibrium/install
#fi

#if test -f /home/Procurator/install ; then
#    /home/GitHub/JackrabbitRelay/Extras/Procurator/install
#fi

#if test -f /home/BlackCrowHunter/install ; then
#    /home/GitHub/JackrabbitRelay/Extras/BlackCrowHunter/install
#fi

NFS=`stat --printf="%s" update`

if [ "$NFS" != "$OFS" ] ; then
    echo Running update again...
    /home/GitHub/JackrabbitRelay/install nopull
fi
