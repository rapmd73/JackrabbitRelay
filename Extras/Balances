#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Jackrabbit Equilibrium
# 2021 Copyright Â© Robert APM Darin
# All rights reserved unconditionally.

import sys
sys.path.append('/home/JackrabbitRelay/Base/Library')
import os
import time
import json

import JRRconfig
import JRRlog
import JRRapi
import JRRsupport

###
### Main code base. Place order on exchange
###

if len(sys.argv) > 2:
    exchangeName=sys.argv[1].lower()
    account=sys.argv[2]
else:
    print("An exchange and a (sub)account must be provided.")
    sys.exit(1)

IsLog=False
if len(sys.argv) > 3:
    if sys.argv[3].lower()=='log':
        LogName=sys.argv[4]
        IsLog=True

keys=JRRsupport.ReadConfig(exchangeName,account)

CurrentKey=(os.getpid()%len(keys))
Active=keys[CurrentKey]

exchange=JRRapi.ExchangeLogin(exchangeName,Active,Notify=False)

if "Retry" in Active:
    RetryLimit=int(Active['Retry'])
else:
    RetryLimit=10

done=False
while not done:
    try:
        markets=exchange.load_markets()
    except:
        pass
    else:
        done=True

balance = exchange.fetch_balance()

if not IsLog:
    coinList=balance['total']
    for coin in coinList:
        bal=float(balance['total'][coin])

        if bal>0.0:
            print(f"{coin:12} {bal:12.8f}")

    if exchange.has['fetchPositions']:
        try:
            positions = exchange.fetch_positions()
            for pos in positions:
                bal=float(pos['contracts'])
                if bal>0.0:
                    print(f"{pos['symbol']:12} {bal:12.8f} {pos['side']:5}")
        except:
            pass
else:
    Balance={}
    Balance['DateTime']=f'{time.time()}'

    coinList=balance['total']
    for coin in coinList:
        bal=float(balance['total'][coin])

        if bal>0.0:
            Balance[coin]=f'{bal:.8f}'

    if exchange.has['fetchPositions']:
        try:
            positions = exchange.fetch_positions()
            for pos in positions:
                bal=float(pos['contracts'])
                if bal>0.0:
                    Balance[coin]=f'{bal:.8f}'
        except:
            pass

    # Write to file

    fh=open(LogName,'a')
    fh.write(json.dumps(Balance)+"\n")
    fh.close()
